---
title: "Using Privacy Enhanced Real-time Conferencing (PERC) in a WebRTC Context"
abbrev: PERC in WebRTC
docname: draft-roach-perc-webrtc-00
date: 2017-03-10
category: info
ipr: trust200902

pi:
  toc: yes
  sortrefs: yes
  symrefs: yes

author:
 -
    ins: A. B. Roach
    name: Adam Roach
    email: adam@nostrum.com
    phone: +1 650 903 0800 x863
    org: Mozilla
    street: \
    city: Dallas
    country: US

normative:
  I-D.ietf-perc-double:
  I-D.ietf-perc-dtls-tunnel:
  I-D.ietf-perc-srtp-ekt-diet:
  I-D.ietf-rtcweb-security-arch:

  W3C.CR-WebIDL-1-20160308:
  W3C.WD-webrtc-20170313:

informative:
  I-D.ietf-perc-private-media-framework:


--- abstract

The Privacy-Enhanced Realtime Conferencing (PERC) architecture defines a
system by which multiparty conferences can be handled by a conference server
that is "semi-trusted": that is, it is trusted to correctly handle media
packets, but it is not trusted with the actual contents of the media
streams. In order to use this architecture within WebRTC, we must describe how
information is conveyed among various network functions. This document describes
the information to be conveyed and how it is transferred.

--- middle


# Introduction

The Privacy-Enhanced Realtime Conferencing (PERC) architecture
{{I-D.ietf-perc-private-media-framework}} defines a
system by which multiparty conferences can be handled by a conference server
that is "semi-trusted": that is, it is trusted to correctly handle media
packets, but it is not trusted with the actual contents of the media
streams. In order to use this architecture within WebRTC
{{W3C.WD-webrtc-20170313}}, we must describe how
information is conveyed among various network functions. This document describes
the information to be conveyed and how it is transferred.

Note that the current document is a fairly high-level thumbnail sketch
of information flow. It will be expanded with further detail once we
have consensus on the general direction for the mechanism.

# Terminology
{::comment}
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and
"OPTIONAL" in this document are to be interpreted as described in BCP 14
{{RFC2119}} {{I-D.leiba-rfc2119-update}} when, and only when, they appear in
all capitals, as shown here.
  RFC2119:
  I-D.leiba-rfc2119-update:
{:/comment}

This document also uses a number of terms defined in section 2 of
{{I-D.ietf-perc-private-media-framework}}. Of particular note, the definitions
for "Media Distributor (MD)" and "Key Distributor (KD)" are provided by that
document.


# Goals

A key goal of the mechanisms described in this document is that it should work
with a minimal set of changes to web browsers that already implement WebRTC. In
particular: PERC requires the use of strong identity assertions in order to
provide any value whatsoever. WebRTC already contains an identity mechanism
{{I-D.ietf-rtcweb-security-arch}}; we do not seek to introduce a second one.
Regarding identity, this document assumes:

* From a WebRTC perspective, the remote identity presented to each conference
  participant will be the identity of the Key Distributor (KD). Whether this
  is identical to the PeerConnection identity presented by the conference
  owner is a matter of policy for the conference application. (Note that this
  is an emergent property of the system rather than a design decision, since
  the DTLS associations used to key the SRTP terminate at the KD in the PERC
  architecture.)

* The KD will validate the identity of each user as they join the conference. The
  roster of current users must be available to at least one of the participants
  through a means that can be trusted as being authentically generated by the KD.

We also seek to support a system that allows for the Key Distributor (KD) to be
co-located with an endpoint as a primary goal, and for the KD to be located on a
dedicated server as an important secondary goal.

# Data Flows

## Key Distributor Co-Located with Browser

When the KD is co-located with the browser, the browser that serves the role of
KD must join the conference before any other media can be exchanged. It is up to
the application to determine whether this is simply the first participant to
join, or a specific participant who has an administrative relationship with the
conference instance. For concision, we will use the term "conference owner" to
refer to the browser serving in this role, even though its assignment may be
arbitrary.

We further posit that browsers that serve as KDs will have specific objects
available as part of their Document Object Model (DOM). These objects will
give applications the ability to instantiate and control such KDs, but without
actually being able to obtain access to the keying material itself. The
definition of the interface for such objects is not defined in this document
more than necessary. We envision a companion document, submitted to the W3C,
to describe this API in detail.

The following callflows illustrate the information exchanged among these entities:

Identity Service:
: This is the server that acts as in Identity Provider (IdP), as that term
is defined in {{I-D.ietf-rtcweb-security-arch}}. Note that the Owner and the
Participant may use different Identity Services to vouch for their identities.

Owner Browser:
: This is the web browser execution environment for the web browser that is
acting as the KD.

Owner PeerConnection:
: This is the RTCPeerConnection object created and used by conferencing web application
running in the Owner Browser.  It is shown separately from the Owner Browser
to clearly indicate those tasks which are performed directly by the RTCPeerConnection
without the ability for the conferencing web application to intervene.

KD:
: This is the Key Distributor function created and used by the conferencing web
application running in the Owner Browser.  It is shown separately from the Owner Browser
to clearly indicate those tasks which are performed directly by the Key Distributor
without the ability for the conferencing web application to intervene.

HTTP Server:
: This is the HTTP server that handles the signaling for the conference.

MD:
: This is the media distributor that handles the media the conference. Note that
the interface between the HTTP Server and the MD is an implementation detail for
the developer of the conference server. The messages exchanged between them
are intended to illustrate the information required to be exchanged between them
to have a properly functioning PERC conference.

Participant Browser:
: This is the web browser execution environment for a web browser that is
not acting as the KD.

Participant PeerConnection:
: This is the RTCPeerConnection object created and used by conferencing web application
running in the Participant Browser.  It is shown separately from the Participant Browser
to clearly indicate those tasks which are performed directly by the RTCPeerConnection
without the ability for the conferencing web application to intervene.

The following sub sections step through an illustrative call flow that demonstrates
how the information needed to create a PERC conference in a WebRTC environment
is exchanged among the aforementioned functions. The call flows occur in the order
shown by these sections -- division into sections is done primarily to limit the
number of elements in any diagram to no more than four, since the limitations of
the internet-draft format makes wider diagrams impossible.

### Conference Establishment

~~~~
 Owner                KD              HTTP Server             MD
Browser                |                   |                   |
   |                   |                   |                   |
   |                   |                   |                   |
   |(1) GET /perc/room-identifier          |                   |
   |-------------------------------------->|                   |
   |(2) 200 OK (with app)                  |                   |
   |<--------------------------------------|                   |
   |(3) new KD();      |                   |                   |
   |------------------>|                   |                   |
   |(4) kd.setIdentity(id1);               |                   |
   |------------------>|                   |                   |
   |(5) kd.getFingerprint();               |                   |
   |------------------>|                   |                   |
   |(6) fingerprint    |                   |                   |
   |<------------------|                   |                   |
   |(7) POST /start-conf (KD fingerprint)  |                   |
   |-------------------------------------->|                   |
   |                   |                   |(8) New Conference |
   |                   |                   |   (KD fingerprint)|
   |                   |                   |------------------>|
   |                   |                   |(9) ack            |
   |                   |                   |<------------------|
   |(10) 200 (MD name and port)            |                   |
   |<--------------------------------------|                   |
   |(11)  kd.connect(mdName,port)          |                   |
   |------------------>|                   |                   |
   |                   |(12) TLS setup     |                   |
   |                   |-------------------------------------->|
   |                   |                   |                   |
   |                   |KD checks that MD cert matches name    |
   |                   |                   |                   |
   |             MD checks that the client fingerprint matches |
   |                   |                   |                   |
   |                   |(13) Profiles      |                   |
   |                   |<--------------------------------------|
   |(14) resolve connect promise           |                   |
   |<------------------|                   |                   |
   |                   |                   |                   |
~~~~

1. The conference owner loads the conference application. Although not required,
   information sufficient to identify the conference is frequently sent as part
   of the URL.
2. The HTTP server returns the conferencing web application.
3. The conferencing web application instantiates a new Key Distributor (KD) object.
   Upon instantiation, this KD creates a new certificate.
4. The conferencing web app sets the owner's identity on the KD.
4. The application asks for the certificate's fingerprint...
5. ...which the KD provides
6. The application initiates the conference, including the KD cert fingerprint as part
   of the initiation message.
7. The HTTP server passes the KD fingerprint along to the Media Distributor (MD). This
   is used later by the MD to ensure that the correct KD is connecting to it.
8. The MD acknowledges creation of a new conference. This acknowledgement contains the
   hostname and port that the MD is listening on for the KD to connect to.
9. The web server responds to the conferencing web app with the hostname of the MD as
   well as the port it is listening on for the KD to connect.
10. The application passes along the MD name and port to the KD object.
11. The KD initiates a TLS connection to the MD. This connection uses the
    protocol defined in {{I-D.ietf-perc-dtls-tunnel}}. The KD verifies that the
    certificate presented by the MD matches the name it used to connect to it, and
    that it chains up to a trusted certificate authority. The MD verifies that
    the client cert provided by the KD matches the fingerprint that it received
    earlier from the HTTP server.
12. The MD returns its list of supported profiles, as described in {{I-D.ietf-perc-dtls-tunnel}}.
13. The KD object indicates to the conferencing app that the KD-MD connection has been
    successfully established.


### Owner Sends Offer to Conference

~~~~
Identity             Owner               Owner               HTTP
 Service             Browser         PeerConnection          Server
    |                   |                   |                   |
    |                   |                   |                   |
    |                   |(1) new PC();      |                   |
    |                   |------------------>|                   |
    |                   |(2) setIdentity(id1);                  |
    |                   |------------------>|                   |
    |                   |(3) createOffer(); |                   |
    |                   |------------------>|                   |
    |(4) GET /.well-known/idp-proxy/default |                   |
    |<--------------------------------------|                   |
    |(5) 200            |                   |                   |
    |-------------------------------------->|                   |
    |(6) XHR POST /sign (offer)             |                   |
    |<--------------------------------------|                   |
    |(7) 200 (signed offer)                 |                   |
    |-------------------------------------->|                   |
    |                   |(8) resolve createOffer() promise      |
    |                   |<------------------|                   |
    |                   |(9) POST /perc/offer?room-identifier   |
    |                   |(with signed offer)|                   |
    |                   |-------------------------------------->|
    |                   |                   |                   |
~~~~

1. The conferencing web application creates a new WebRTC RTCPeerConnection (PC)
   object to allow sending and receiving media.
2. The conferencing web app sets the owner's identity on the PC...
3. ...and requests an offer to be created.
4. As described in {{I-D.ietf-rtcweb-security-arch}}, the PC requests the IDP
   proxy code from the Identity Service...
5. ...which it returns.
6. Upon being executed, the idp-proxy code sends the offer to the Identity service...
7. ...which verifies user's identity, the signs the offer, and returns the signed offer
   to the PC.
8. The PC then returns the signed offer to the conferencing web app.
9. The conferencing web app sends the signed offer to the HTTP server to begin establishing
   the media connection.

### Conference Processes Owner Offer

~~~~
Identity               KD                 HTTP                 MD
 Service                                 Server
    |                   |                   |                   |
    |                   |                   |(1) signed offer   |
    |                   |                   |------------------>|
    |                   |                   |                   |
    |                   |(2) sign(offer, answer)                |
    |                   |<--------------------------------------|
    |(3) GET /.well-known/idp-proxy/default |                   |
    |<------------------|                   |                   |
    |(4) 200 (with public key)              |                   |
    |------------------>|                   |                   |
    |(5) GET /.well-known/idp-proxy/default |                   |
    |<------------------|                   |                   |
    |(6) 200            |                   |                   |
    |------------------>|                   |                   |
    |(7) XHR POST /sign (MD answer)         |                   |
    |<------------------|                   |                   |
    |(8) 200 (signed MD answer)             |                   |
    |------------------>|                   |                   |
    |                   |(9) signed answer, KD identity         |
    |                   |-------------------------------------->|
    |                   |                   |(10) signed answer |
    |                   |                   |<------------------|
    |                   |                   |                   |
~~~~

In this section of the flow, the MD sends generates an answer. It sends this
answer to the KD so that it can sign it with an assertion of the KD's
identity. It also sends the corresponding offer to the KD so that the KD can
validate that the authenticated party who generated the offer is authorized to
join the conference, and to allow the KD to add that user to its own notion of
the current conference roster.

1. The HTTP server sends the signed offer to the MD to allow it to start setting up
   the media connection.
2. The MD creates an answer to the received offer, and sends both offer and answer
   over the MD-KD tunnel connection.
3. Similar to the PC validation procedure described in {{I-D.ietf-rtcweb-security-arch}},
   the KD requests the IDP proxy code from the Identity Service based on the identity
    in the offer...
4. ...which it returns. The KD uses the IDP proxy code to validate the identity of the
   party that generated the offer.
5. Similar to the PC signing procedure described in
   {{I-D.ietf-rtcweb-security-arch}}, the KD requests the IDP
   proxy code from the Identity Service...
6. ...which it returns.
7. Upon being executed, the idp-proxy code sends the MD answer to the Identity Service...
8. ...which verifies KD's identity, the signs the MD answer, and returns the signed MD answer
   to the KD.
9. The KD sends the signed MD answer back to the MD.
10. The MD sends the signed answer to the HTTP server.


### Owner Processes Answer

~~~~
Identity              Owner               Owner               HTTP
 Service             Browser         PeerConnection          Server
    |                   |                   |                   |
    |                   |                   |                   |
    |                   |                   |                   |
    |                   |(1) 200 (signed answer)                |
    |                   |<--------------------------------------|
    |                   |(2) setRemoteDescription(answer)       |
    |                   |------------------>|                   |
    |(3) GET /.well-known/idp-proxy/default |                   |
    |<--------------------------------------|                   |
    |(4) 200 (with public key)              |                   |
    |-------------------------------------->|                   |
    |PC validates signature with public key from Identity Service
    |                   |                   |                   |
    |                   |                   |                   |
~~~~

1. To complete the offer/answer exchange, the HTTP server returns the signed
   answer (asserting the KD's identity) to the owner's conference web app.
2. The conference web app sets the remote description on the PC to the received
   answer
3. Using the identity validation procedure described in {{I-D.ietf-rtcweb-security-arch}},
   the PC requests the IDP proxy code from the Identity Service based on the identity
    in the answer...
4. ...which it returns. The PC uses the IDP proxy code to validate the identity of the
   party that generated the answer.

### Owner sets up media connection

Note: ICE/ICE Lite is not shown in this flow, but is assumed to have taken
place.

~~~~
        Owner                KD                  MD
   PeerConnection
          |                   |                   |
          |                   |                   |
          |(1) DTLS setup     |                   |
          |-------------------------------------->|
          |                   |(2) Tunnel(DTLS setup)
          |                   |<------------------|
          |(3) Double encrypted media             |
          |.......................................|
          |                   |                   |
          |                   |                   |
~~~~

1. The PC, using the addressing information present in the answer, negotiates a DTLS
   association towards the MD. We make an assumption that the SDP generated by the MD
   contains a port number that is unique to the conference, allowing it to correlate
   the incoming DTLS messages to the correct KD.
2. The MD uses the tunneling protocol defined in {{I-D.ietf-perc-dtls-tunnel}}
   to forward the DTLS setup messages between the PC and the KD. These DTLS
   setup messages make use of the mechanism described in {{I-D.ietf-perc-srtp-ekt-diet}}
   to establish end-to-end keys for the media.
3. Using the mechanism described in {{I-D.ietf-perc-double}}, the PC now
   begins to send and received SRTP-encrypted media to and from the MD.


### Participant Joins Conference

After the conference has been established as described in the preceding sections, each new
participant triggers a flow that closely mirrors the owner PC's interaction with the
conference. These steps are shown in the following sections.

~~~~
HTTP           Participant         Participant          Identity
Server           Browser         PeerConnection          Service
|                   |                   |                   |
|(1) GET /perc/room-identifier          |                   |
|<------------------|                   |                   |
|(2) 200 OK (with app)                  |                   |
|------------------>|                   |                   |
|                   |(3) new PC();      |                   |
|                   |------------------>|                   |
|                   |(4) setIdentity(id2);                  |
|                   |------------------>|                   |
|                   |(5) createOffer(); |                   |
|                   |------------------>|                   |
|                   |                   |(6) GET            |
|                   |                   |/.well-known/idp-proxy/default
|                   |                   |------------------>|
|                   |                   |(7) 200            |
|                   |                   |<------------------|
|                   |                   |(8) XHR POST /sign (offer)
|                   |                   |------------------>|
|                   |                   |(9) 200 (signed offer)
|                   |                   |<------------------|
|                   |(10) resolve createOffer() promise     |
|                   |<------------------|                   |
|(11) POST /perc/offer?room-identifier (signed offer)       |
|<------------------|                   |                   |
|                   |                   |                   |
~~~~

1. The conference owner loads the conference application. Although not required,
   information sufficient to identify the conference is frequently sent as part
   of the URL.
2. The HTTP server returns the conferencing web application.
3. The conferencing web application creates a new WebRTC RTCPeerConnection (PC)
   object to allow sending and receiving media.
4. The conferencing web app sets the owner's identity on the PC...
5. ...and requests an offer to be created.
6. As described in {{I-D.ietf-rtcweb-security-arch}}, the PC requests the IDP
   proxy code from the Identity Service...
7. ...which it returns.
6. Upon being executed, the idp-proxy code sends the offer to the Identity service...
8. ...which verifies user's identity, the signs the offer, and returns the signed offer
   to the PC.
9. The PC then returns the signed offer to the conferencing web app.
10. The conferencing web app sends the signed offer to the HTTP server to begin establishing
    the media connection.


### Conference Processes Participant Offer

~~~~
Identity               KD                 HTTP                 MD
 Service                                 Server
    |                   |                   |                   |
    |                   |                   |(1) offer          |
    |                   |                   |------------------>|
    |                   |(2) sign(offer, answer)                |
    |                   |<--------------------------------------|
    |(3) GET /.well-known/idp-proxy/default |                   |
    |<------------------|                   |                   |
    |(4) 200 (with public key)              |                   |
    |------------------>|                   |                   |
    |(5) GET /.well-known/idp-proxy/default |                   |
    |<------------------|                   |                   |
    |(6) 200            |                   |                   |
    |------------------>|                   |                   |
    |(7) XHR POST /sign (MD answer)         |                   |
    |<------------------|                   |                   |
    |(8) 200 (signed MD answer)             |                   |
    |------------------>|                   |                   |
    |                   |(9) signed answer, KD identity         |
    |                   |-------------------------------------->|
    |                   |                   |(10) signed answer |
    |                   |                   |<------------------|
    |                   |                   |                   |
~~~~

This flow is identical to conference processing of the owner's offer. It is included
here for completeness.

1. The HTTP server sends the signed offer to the MD to allow it to start setting up
   the media connection.
2. The MD creates an answer to the received offer, and sends both offer and answer
   over the MD-KD tunnel connection.
3. Similar to the PC validation procedure described in {{I-D.ietf-rtcweb-security-arch}},
   the KD requests the IDP proxy code from the Identity Service based on the identity
    in the offer...
4. ...which it returns. The KD uses the IDP proxy code to validate the identity of the
   party that generated the offer.
5. Similar to the PC signing procedure described in
   {{I-D.ietf-rtcweb-security-arch}}, the KD requests the IDP
   proxy code from the Identity Service...
6. ...which it returns.
7. Upon being executed, the idp-proxy code sends the MD answer to the Identity Service...
8. ...which verifies KD's identity, the signs the MD answer, and returns the signed MD answer
   to the KD.
9. The KD sends the signed MD answer back to the MD.
10. The MD sends the signed answer to the HTTP server.

### Participant Processes Answer

~~~~
Identity              HTTP             Participant         Participant
 Service             Server              Browser         PeerConnection
    |                   |                   |                   |
    |                   |                   |                   |
    |                   |                   |                   |
    |                   |(1) 200 (signed answer)                |
    |                   |------------------>|                   |
    |                   |                   |(2) setRemoteDescription
    |                   |                   |    (answer)       |
    |                   |                   |------------------>|
    |(3) GET /.well-known/idp-proxy/default |                   |
    |<----------------------------------------------------------|
    |(4) 200 (with public key)              |                   |
    |---------------------------------------------------------->|
    |PC validates signature with public key from Identity Service
    |                   |                   |                   |
~~~~

This flow is identical to owner's processing of the conference's answer. It is included
here for completeness.

1. To complete the offer/answer exchange, the HTTP server returns the signed
   answer (asserting the KD's identity) to the owner's conference web app.
2. The conference web app sets the remote description on the PC to the received
   answer
3. Using the identity validation procedure described in {{I-D.ietf-rtcweb-security-arch}},
   the PC requests the IDP proxy code from the Identity Service based on the identity
    in the answer...
4. ...which it returns. The PC uses the IDP proxy code to validate the identity of the
   party that generated the answer.

### Participant sets up media connection

~~~~
         KD                  MDD             Participant
                                           PeerConnection
          |                   |                   |
          |                   |(1) DTLS setup     |
          |                   |<------------------|
          |(2) Tunnel(DTLS setup)                 |
          |<------------------|                   |
          |                   |(3) Double encrypted media
          |                   |...................|
          |                   |                   |
~~~~

This flow is identical to the owner's establishment of encrypted media. It is
included here for completeness.

1. The PC, using the addressing information present in the answer, negotiates a DTLS
   association towards the MD. We make an assumption that the SDP generated by the MD
   contains a port number that is unique to the conference, allowing it to correlate
   the incoming DTLS messages to the correct KD.
2. The MD uses the tunneling protocol defined in {{I-D.ietf-perc-dtls-tunnel}}
   to forward the DTLS setup messages between the PC and the KD. These DTLS
   setup messages make use of the mechanism described in {{I-D.ietf-perc-srtp-ekt-diet}}
   to establish end-to-end keys for the media.
3. Using the mechanism described in {{I-D.ietf-perc-double}}, the PC now
   begins to send and received SRTP-encrypted media to and from the MD.

## Key Distributor Separate From Browser

This configuration introduces a couple of challenges. It is not explored in depth
in this version of the document; however, we highlight the following two issues:

* Because identity in WebRTC is inherently based on evaluation of Javascript,
  and because the KD must validate identities to perform its intended purpose,
  the KD will be required to include a Javascript execution environment.

* Because the KD is the only trusted node that inherently has access to the list of
  active conference participants, we must introduce additional mechanisms that allow
  it to convey this information to conference participants in a way that can be
  authenticated.

# New Mechanisms Required

Based on the foregoing message flows, we need to add a small number of new mechanisms
to the overall system.

## New Key Distributor DOM Object

Although the formal definition of the Key Distributor DOM object will be provided
by a W3C document, the foregoing message flows imply that we will need an
interface that looks roughly like the following. This interface is expressed
using the syntax defined by {{W3C.CR-WebIDL-1-20160308}}, and refers to a
number of structures defined in {{W3C.WD-webrtc-20170313}}.


~~~~
interface RTCKeyDistributor : EventTarget {
    void setIdentityProvider(DOMString provider,
                         optional RTCIdentityProviderOptions options);

    Promise<DOMString> getIdentityAssertion();
    readonly attribute Promise<RTCIdentityAssertion> peerIdentity;
    readonly attribute DOMString?                    idpLoginUrl;
    readonly attribute DOMString?                    idpErrorInfo;

    Promise<RTCCertificate> getCertificate();

    Promise<void> connect(DOMString mdHost, unsigned short mdPort);

    attribute EventHandler              onfingerprintfailure;
}
~~~~

## New "sign" Tunnel Message

We also need to add new "sign_answer" and "sign_answer_ack" MsgTypes to the
protocol defined in {{I-D.ietf-perc-dtls-tunnel}}. These are used by the MD to
request that the KD sign its answer.

The "SignAnswer" message is defined as follows:

~~~~
struct {
  opaque offer<1..2^24-1>;
  opaque answer<1..2^24-1>;
} SignAnswer;
~~~~

The "SignAnswerAck" message is defined as follows:

~~~~
struct {
  opaque answer<1..2^24-1>;
} SignAnswerAck;
~~~~

Security Considerations
=======================

This section will be fleshed out further after the working group has general
agreement about the direction this mechanism should take.

The means by which the KD determines that the offer being presented in the "sign" message
corresponds to the current conference and has not been replayed has not yet been analyzed.

We need to ensure that MD answers signed by the KD cannot be used by the MD as offers in
other contexts, as doing so would allow the MD to impersonate the KD's identity.

IANA Considerations
===================

This document requires no actions from IANA.
